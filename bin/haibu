#!/usr/bin/env node

var path = require('path'),
    util = require('util'),
    flatiron = require('flatiron'),
    argv = require('optimist').argv,
    haibu = require('../lib/haibu');

var help = [
    'usage: haibu-server [options]',
    '',
    'Starts the haibu API server responsible for spawning node.js applications.',
    '',
    'options:',
    '  -a                  IP Address that you want the server to bind to  [dynamic]',
    '  -p                  Port that you want the server to run on         [9002]',
    '  -e [env]            The environment to the specified command in     [development]',
    '  --logger            Use the haibu logger plugin                     [true]',
    '  --chroot            Deploy drones using chroot',
    '  --advanced-replies  Send extra info with replies',
    '  -s --silent         Suppress the log messages from the output',
    '  -h, --help          You\'re staring at it',
].join('\n');

haibu.config.argv().env().file({ file: path.join(__dirname, '..', 'config', 'config.json') });

if (argv.h || argv.help) {
  util.puts(help);
}
else {
  var env  = haibu.config.get('env') || haibu.config.get('NODE_ENV') || 'development',
      port = haibu.config.get('p') || haibu.config.get('port') || 9002;

  var plugins = haibu.config.get('plugins');
  if (plugins) {
    console.error(plugins)
    Object.keys(plugins).forEach(function usePlugin(plugin) {
      var options = haibu.config.get('plugins:' + plugin);
      if (!options || typeof options !== 'object') options = {};
      haibu.use(haibu.plugins[plugin], options);
    });
  }
  
  haibu.use(flatiron.plugins.http);
  haibu.createRoutes(haibu.router);
  haibu.common.getIpAddresses(argv.a, function (err, addresses) {
    if (err) {
      haibu.emit('error', err);
    }
    
    var address = addresses[0];
    var options = {
      env: env,
      port: port,
      host: address
    };
    
    console.error('starting')
    haibu.start(options.port, function () {
      console.error(arguments)
      haibu.common.showWelcome('api-server', address, port);
    });
  });
}